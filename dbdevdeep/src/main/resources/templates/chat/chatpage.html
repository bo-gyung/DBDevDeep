<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
     layout:decorate="~{include/chat_layout}">
<th:block layout:fragment="content">
<style>
	.custom-badge{
		border-radius:50em; 
		align-self: flex-end; 
		margin-bottom: 5px;
	}
</style>
<body>
	
	<!-- 사진 상세보기 모달창 시작 -->
    <div id="imgModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="imgModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="imgModalLabel">사진 상세보기</h4>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light"
                        data-dismiss="modal">닫기</button>
                    <a id="downloadBtn" href="" download class="btn btn-primary" style="display:none;">저장하기</a>
				</div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
	<!-- 사진 상세보기 모달창 끝 -->


        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
			<!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid pb-0 pt-4">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                        	<input type="hidden" id="csrf_token" th:value="${_csrf.token}"/>
                        	<!--채팅방 목록 + 채팅방 시작 -->
                            <div class="row no-gutters">
                            	<!-- 채팅방 목록 시작 -->
                                <div class="col-lg-3 border-right">
                                   	<!-- 채팅방 목록 검색창 시작 -->
                                    <div class="card-body border-bottom">
                                        <form>
                                            <input class="form-control" type="text" placeholder="Search Contact">
                                        </form>
                                    </div>
                                    <!-- 채팅방 목록 검색창 검색창 끝 -->
                                    <!-- 개설된 채팅방 목록 시작 -->
                                    <div class="scrollable position-relative" id="chat_room_list" style="height: 70vh;" th:fragment="chatRoomList">
                                        <ul class="mailbox list-style-none">
                                            <li>
                                                <div class="message-center">
                                                    <th:block th:if="${#lists.isEmpty(ccrDtoList)}">
                                                    	<p>생성된 채팅방이 없습니다.</p>
                                                    </th:block>
                                                    <th:block th:if="${!#lists.isEmpty(ccrDtoList)}">
                                                    	<!-- 채팅방 -->
                                                    	<th:block th:each="ccrDto, ccrDtoStat : ${ccrDtoList}">
		                                                    <a href="javascript:void(0)"
		                                                    	onclick="enterChatRoom(this);"
		                                                        class="message-item d-flex align-items-start border-bottom px-3 py-2">
		                                                        <input type="hidden" th:value="${ccrDto.room_no}">
		                                                        <div class="user-img"><img th:src="@{'/UploadImg/employee/' + ${ccrDto.room_pic}}" 
		                                                                alt="user" class="img-fluid rounded-circle" 
		                                                                style="aspect-ratio: 1/1; object-fit: cover;" 
		                                                                width="40px">
		                                                        </div>
		                                                        <div class="w-75 d-inline-block v-middle pl-2">
		                                                            <h6 class="message-title mb-0 mt-1" th:text="${ccrDto.room_name}"></h6>
		                                                            <span class="font-12 text-nowrap d-block text-muted text-truncate" 
		                                                            th:text="${ccrDto.last_chat}"></span>
		                                                            <span class="font-12 text-nowrap d-block text-muted" 
		                                                            th:text="${#temporals.format(ccrDto.last_time, 'yyyy.MM.dd HH:mm')}"></span>
		                                                        </div>
		                                                        <span class="badge badge-primary custom-badge notify-no d-flex align-items-center justify-content-center" 
														             style="aspect-ratio: 1/1; width:24px;">
														           3
														       </span>
		                                                    </a>
                                                    	</th:block>
                                                    </th:block>
                                                    
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- 개설된 채팅방 목록 끝 -->
                                </div>
                                <!--채팅방 목록 끝 -->
                                <!-- 채팅 메세지 리스트 시작 -->
                                <div class="col-lg-9">
	                                <div id="chat_container">
	                                	<div th:fragment="chatContainer">
	                                		<!-- 채팅방 이름 시작 -->
		                                	<th:block th:if="${roomName != null and !roomName.isEmpty()}">
			                                	<div class="card-body border">
			                                        <div class="row">
			                                            <div class="col-12">
			                                                <div class="input-field mt-0 mb-0">
			                                                	<div th:text="${roomName}" style="height: 4.1vh; line-height : 4.1vh;"></div>
			                                                    <input type="hidden" id="thisRoomNo" th:value="${roomNo}">
			                                                </div>
			                                            </div>
			                                        </div>
			                                    </div>
		                                	</th:block>
		                                	<!-- 채팅방 이름 끝 -->
		                                    <div class="chat-box scrollable position-relative" id="messageContainer"
		                                        th:style="${roomName == null || roomName.isEmpty()} ? 'height: 70vh;' : 'height: 60vh;'">
		                                        <!-- 전체 채팅 메세지 리스트 시작 -->
	                                        	<th:block th:if="${#lists.isEmpty(combinedList)}">
	                                        		<div style="text-align : center; height: 50vh; line-height : 50vh;">
			                                                대화할 채팅방을 선택하세요.
	                                                </div>
	                                        	</th:block>
	                                        	<!-- 채팅 메세지 시작 -->
		                                        <ul class="chat-list list-style-none px-3 pt-3">
		                                        	<th:block th:if="${!#lists.isEmpty(combinedList)}">
		                                        		<th:block th:each="chat, chatStat : ${combinedList}">
			                                            	<!-- 챗 타입이 사용자 -->
			                                            	<th:block th:if="${chat.type.equals('me')}">
				                                                 <li class="chat-item odd list-style-none mt-3">
				                                                 	<!-- 사진파일이 존재한다면 -->
				                                                 	<th:block th:if="${chat.new_pic_name != null}">
					                                                 	<div class="chat-content text-right d-inline-block pl-3">
					                                                 		<!-- 읽음확인 -->
						                                                 	<div class="text-right d-inline-block font-10 p-1" style="vertical-align: bottom;">1</div>
						                                                 	<img th:src="@{'/UploadImg/chat/' + ${chat.new_pic_name}}" 
						                                                 			th:alt="${chat.ori_pic_name}" 
						                                                 			style="max-width: 12.5vw; height: auto;" 
							                                                        onerror="this.onerror=null; 
							                                                        		this.src='/assets/images/noimage.png';
							                                                        		this.alt='no image';" 
						                                                 			onload="scrollToBottom()" 
				                                                 				 	data-toggle="modal" data-target="#imgModal" 
							                                                        onclick="openModal(this)">
					                                                 	</div>
				                                                 	</th:block>
				                                                 	<!-- 사진파일이 존재하지 않는다면 -->
				                                                 	<th:block th:if="${chat.new_pic_name == null || #strings.isEmpty(chat.new_pic_name)}">
					                                                 	<div class="chat-content text-right d-inline-block pl-3">
						                                                 	<!-- 읽음확인 -->
						                                                 	<div class="text-right d-inline-block font-10 p-1" style="vertical-align: bottom;">1</div>
						                                                    <div class="box msg p-2 d-inline-block mb-1" 
						                                                    th:text="${chat.content}"></div>
						                                                </div>
				                                                 	</th:block>
					                                                <!-- 작성시간 -->
					                                                <div class="chat-time text-right d-block font-10 mt-1 mr-0 mb-3" 
					                                                th:text="${#temporals.format(chat.timestamp, 'yyyy.MM.dd HH:mm')}"></div>
					                                            </li>
			                                            	</th:block>
			                                            	<!-- 챗 타입이 사용자가 아님 -->
			                                            	<th:block th:if="${chat.type.equals('notMe')}">
			                                            		<li class="chat-item list-style-none mt-3">
			                                            			<!-- 프로필 사진 -->
					                                                <div class="chat-img d-inline-block">
					                                                	<img th:src="@{'/UploadImg/employee/' + ${chat.profile_pic}}" alt="user"
					                                                        class="rounded-circle" 
					                                                        style="aspect-ratio: 1/1; object-fit: cover;" width="50"
					                                                        onerror="this.onerror=null; this.src='/assets/images/users/user-profile.png';">
					                                                </div>
					                                                <div class="chat-content d-inline-block pl-3">
					                                                	<!-- 이름 -->
					                                                    <h6 class="font-weight-medium" th:text="${chat.writer_name}"></h6>
				                                                    	<!-- 사진파일이 존재한다면 -->
					                                                 	<th:block th:if="${chat.new_pic_name != null}">
						                                                 	<img th:src="@{'/UploadImg/chat/' + ${chat.new_pic_name}}" 
						                                                 			th:alt="${chat.ori_pic_name}" 
						                                                 			style="max-width: 12.5vw; height: auto;" 
							                                                        onerror="this.onerror=null; 
							                                                        		this.src='/assets/images/noimage.png';
							                                                        		this.alt='no image';" 
						                                                 			onload="scrollToBottom()" 
					                                                 				data-toggle="modal" data-target="#imgModal" 
							                                                        onclick="openModal(this)">
					                                                        <!-- 읽음확인 -->
						                                                 	<div class="d-inline-block font-10 p-1" style="vertical-align: bottom;">1</div>
					                                                 	</th:block>
					                                                 	<!-- 사진파일이 존재하지 않는다면 -->
					                                                 	<th:block th:if="${chat.new_pic_name == null || #strings.isEmpty(chat.new_pic_name)}">
						                                                    <div class="box msg p-2 d-inline-block mb-1" 
						                                                    th:text="${chat.content}"></div>
						                                                    <!-- 읽음확인 -->
						                                                 	<div class="d-inline-block font-10 p-1" style="vertical-align: bottom;">1</div>
					                                                 	</th:block>
					                                                </div>
					                                                <!-- 작성시간 -->
					                                                <div class="chat-time d-block font-10 mt-1 mr-0 mb-3" 
					                                                th:text="${#temporals.format(chat.timestamp, 'yyyy.MM.dd HH:mm')}"></div>
					                                            </li>
			                                            	</th:block>
			                                            	<!-- 챗 타입이 상태이력 -->
			                                            	<th:block th:if="${chat.type.equals('history')}">
				                                                <li class="chat-item list-style-none mt-3">
				                                                 	<!-- 이력내용 -->
					                                                <div class="chat-content text-center d-inline-block pl-3">
					                                                    <div class="box msg p-2 d-inline-block mb-1" 
					                                                    style="background-color:transparent !important;">
					                                                    	<div th:switch="${chat.content}">
						                                                    	<span th:text="${chat.writer_name}"></span>님이 
																	            <span th:case="1">입장 하셨습니다.</span>
																	            <span th:case="2">퇴장 하셨습니다.</span>
																	            <span th:case="3">초대 되었습니다.</span>
																	            <span th:case="4">강퇴 되었습니다.</span>
																	            <span th:case="*">알 수 없음</span>
																	        </div>
				                                                    	</div>
					                                                </div>
					                                            </li>
			                                            	</th:block>
		                                        		</th:block>
		                                        	</th:block>
		                                        	<!-- 채팅 메세지 끝 -->
		                                        </ul>
		                                        <!-- 전체 채팅 메세지 리스트 끝 -->
		                                    </div>
		                                	<!-- 채팅 메세지 입력창 시작 -->
		                                	<th:block th:if="${roomName != null and !roomName.isEmpty()}">
				                                <div class="card-body border-top">
				                                    <div class="row">
				                                        <div class="col d-flex justify-content-end" style="height: 4vh;">
			                                                <input id="messageInput" placeholder="대화를 입력하세요."
			                                                    class="form-control border-0" type="text">
		                                                	<input type="file" id="attr_pic" style="display: none;">
				                                            <a class="btn-circle btn-lg btn-primary float-right text-white mx-2" id="picButton" 
				                                                href="javascript:void(0)"><i class="fas fa-image" 
				                                                accept=".jpg,.jpeg,.png,.gif,.bmp" ></i></a>
			                                                <a class="btn-circle btn-lg btn-primary float-right text-white mx-2" id="sendButton" 
			                                                	href="javascript:void(0)"><i class="fas fa-paper-plane  "></i></a>
				                                        </div>
				                                    </div>
				                                </div>
		                                	</th:block>
		                                	<!-- 채팅 메세지 입력창 끝 -->
	                                	</div>
	                               	</div>   
                                </div>
                                <!-- 채팅방 상세 끝 -->
                            </div>
                            <!--채팅방 목록 + 채팅창 끝 -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- footer -->
            <!-- ============================================================== -->
            <footer class="footer text-center pt-0">
                All Rights Reserved by Adminmart. Designed and Developed by <a
                    href="https://wrappixel.com">WrapPixel</a>.
            </footer>
            <!-- ============================================================== -->
            <!-- End footer -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Page wrapper  -->
        <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- This page JavaScript -->
    <!-- ============================================================== -->
	<script type="text/javascript">
	
		
		// 이벤트 위임을 통해 동적으로 추가된 요소에 이벤트 바인딩
		document.body.addEventListener("click", function(event) {
		    const sendButton = document.getElementById("sendButton");
		
		    // 클릭된 대상이 sendButton이거나 sendButton의 하위 요소인 경우
		    if (sendButton && (event.target === sendButton || sendButton.contains(event.target))) {
		        const messageInput = document.getElementById("messageInput");
		        if (messageInput && messageInput.value.trim() !== '') {
		            sendMessage(); // 메시지 전송 함수 호출
		        } else {
		            alert("텍스트를 입력하세요.");
		        }
		    }
		    
		    const picButton = document.getElementById('picButton');
		    
			 // 클릭된 대상이 imageButton이거나 imageButton의 하위 요소인 경우
			 if (picButton && (event.target === picButton || picButton.contains(event.target))) {
		    	// 아이디가 attr_img인 인풋 타입 파일 요소를 선택
			    const fileInput = document.getElementById('attr_pic');
			    fileInput.click();
	    	}
		    
		});
		
		// 이벤트 위임을 통해 Enter 키로 메시지 전송 이벤트 처리
		document.body.addEventListener("keyup", function(event) {
		    const messageInput = document.getElementById("messageInput");

		    if (event.target && event.target.id === "messageInput" && event.key === 'Enter') {
		        if (messageInput && messageInput.value.trim() !== '') {
		            sendMessage(); // 메시지 전송 함수 호출
		        } else {
		            alert("텍스트를 입력하세요.");
		        }
		    }
		});
		
		// 파일이 선택되었을 때 실행되는 이벤트
		document.body.addEventListener('change', function(event) {
			if (event.target && event.target.id === 'attr_pic') {
			    const file = event.target.files[0]; // 첫 번째 파일만 선택
	
			    // 파일이 선택되지 않았을 때
			    if (!file) {
			        return;
			    }
	
			    // 파일 크기 확인 (5MB = 5 * 1024 * 1024 bytes)
			    const maxSize = 5 * 1024 * 1024; // 5MB
			    if (file.size > maxSize) {
			        alert("파일 크기는 5MB를 초과할 수 없습니다.");
			        return;
			    }
	
			    // 파일 확장자가 유효한지 확인 (이미지 파일만 허용)
			    const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp'];
			    const fileExtension = file.name.split('.').pop().toLowerCase();
			    if (!validExtensions.includes(fileExtension)) {
			        alert("허용된 파일 형식은 .jpg, .jpeg, .png, .gif, .bmp입니다.");
			        return;
			    }
	
			    // 유효한 파일이 선택된 경우 sendMessage() 함수 호출
			    sendPic(file);
				
			}
		});

	    
		// 메시지를 전송하는 함수
		function sendMessage() {
			// csrf토큰
			const csrfToken = document.getElementById("csrf_token").value;
			// 메세지 내용
		    const msg = document.getElementById("messageInput").value;
			// 메세지를 보낸 방번호 
			const roomNo = document.getElementById("thisRoomNo").value;
		    
			fetch(`/chatmsg/${roomNo}`,{
				method:'POST',
				headers:{
					'Content-Type': 'application/json',
		            "X-CSRF-TOKEN": csrfToken
				},
				body: JSON.stringify({
					chat_content: msg,
					room_no: roomNo
				})
			})
			.then(response => response.json())
		    .then(data => {
		    	if (data.res_code == '200') {
			    	// 작성 채팅 초기화
		        	document.getElementById('messageInput').value = "";
					// 채팅방 대화내용 갱신
		        	loadChatroom(roomNo);
					// 참여중인 채팅방 리스트 갱신
					updateChatRoomList();
		    	} else {
		            Swal.fire({
		                icon: 'error',
		                title: '실패',
		                text: data.res_msg
		            });
		        }
			})
		}
		
		
		// 서버로 파일을 전송하는 함수
		function sendPic(file) {
			
			// csrf토큰
			const csrfToken = document.getElementById("csrf_token").value;
			// 이미지를 보낸 방번호 
			const roomNo = document.getElementById("thisRoomNo").value;
			
		    const formData = new FormData();
		    formData.append('pic', file);
		
		    fetch(`/chatpic/${roomNo}`, {
		        method: 'POST',
		        headers:{
		            "X-CSRF-TOKEN": csrfToken
				},
		        body: formData
		    })
		    .then(response => response.json())
		    .then(data => {
		    	if (data.res_code == '200') {
		    		// 파일 선택 창 초기화
		        	document.getElementById("attr_pic").value = '';
					// 채팅방 대화내용 갱신
		        	loadChatroom(roomNo);
					// 참여중인 채팅방 리스트 갱신
					updateChatRoomList();
		    	} else {
		            Swal.fire({
		                icon: 'error',
		                title: '실패',
		                text: data.res_msg
		            });
		        }
			})
		}

		
		// 채팅방 목록을 클릭하여 채팅방 입장
		function enterChatRoom(element){
			
			const roomNo = element.querySelector('input[type="hidden"]').value;
			loadChatroom(roomNo);
			sendRoomNoInfo(roomNo);
		}
		
		// 채팅방 대화내용 불러오기, 갱신하기
		function loadChatroom(roomNo){
			// csrf토큰
			const csrfToken = document.getElementById("csrf_token").value;
			
			fetch(`/chatrooms/${roomNo}`,{
				method:'GET',
				headers:{
					'X-CSRF-TOKEN': csrfToken // CSRF 토큰 추가
				}
			})
			.then(response => response.text())
			.then(fragment=>{
				// 가져온 HTML 프래그먼트를 파싱하여 DOM에 삽입
		        document.getElementById('chat_container').innerHTML = fragment;
				// 메시지가 로드된 후 스크롤을 아래로 이동
	            scrollToBottom();
			})
		}
		
		// 웹소켓으로 채팅방 정보 전송
		function sendRoomNoInfo(roomNo) {
		    // WebSocket 연결이 열려 있는 경우에만 정보 전송
		    try {
		        if (socket && socket.readyState === WebSocket.OPEN) {
		            socket.send(JSON.stringify({
		                type: "ROOM_NO", // 메시지 타입
		                roomNo: roomNo   // 현재 채팅방 번호
		            }));
		        } else {
		            console.warn("WebSocket is not open: ", socket.readyState);
		        }
		    } catch (error) {
		        console.error("Failed to send WebSocket message: ", error);
		    }
	    }

		
		// 스크롤 최하단으로 고정
		function scrollToBottom() {
		    const chatContainer = document.getElementById('messageContainer'); // 채팅 메시지를 출력하는 요소의 ID
		    chatContainer.scrollTop = chatContainer.scrollHeight; // 스크롤을 최하단으로 설정
		}
			
		
		// 모달창에서 이미지 출력 및 다운로드
		const openModal = function(image){
			// 클릭한 이미지 src정보 가져오기
			const selectImgSrc = image.src;
			const selectImgAlt = image.alt;
			
			// 모달 창 안의 이미지 요소를 찾아 src 설정
			const modalImg = document.getElementById("modalImage");
			modalImg.src = selectImgSrc;
			modalImg.alt = selectImgAlt;
			
			// 다운로드 버튼 설정
	        const downloadBtn = document.getElementById('downloadBtn');
	        downloadBtn.href = selectImgSrc;
	        downloadBtn.download = selectImgAlt;
	        
	     	// 이미지의 alt가 'missing image'이면 저장하기 버튼을 숨김
	        if (selectImgAlt === 'no image') {
	        	downloadBtn.style.display = 'none';  // 저장하기 버튼 숨기기
	        } else {
	        	downloadBtn.style.display = 'inline-block';  // 저장하기 버튼 표시
	        }
	     	
		}

	</script>
    <!-- ============================================================== -->
    <!-- end page JavaScript -->
    <!-- ============================================================== -->
</body>

</html>