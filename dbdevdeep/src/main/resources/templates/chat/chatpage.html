<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
     layout:decorate="~{include/chat_layout}">
<th:block layout:fragment="content">
<body>

        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
			<!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid pb-0 pt-4">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                        	<input type="hidden" id="csrf_token" th:value="${_csrf.token}"/>
                        	<!--채팅방 목록 + 채팅방 시작 -->
                            <div class="row no-gutters">
                            	<!-- 채팅방 목록 시작 -->
                                <div class="col-lg-3 border-right">
                                   	<!-- 채팅방 목록 검색창 시작 -->
                                    <div class="card-body border-bottom">
                                        <form>
                                            <input class="form-control" type="text" placeholder="Search Contact">
                                        </form>
                                    </div>
                                    <!-- 채팅방 목록 검색창 검색창 끝 -->
                                    <!-- 개설된 채팅방 목록 시작 -->
                                    <div class="scrollable position-relative" id="chat_room_list" style="height: 70vh;" th:fragment="chatRoomList">
                                        <ul class="mailbox list-style-none">
                                            <li>
                                                <div class="message-center">
                                                    <th:block th:if="${#lists.isEmpty(ccrDtoList)}">
                                                    	<p>생성된 채팅방이 없습니다.</p>
                                                    </th:block>
                                                    <th:block th:if="${!#lists.isEmpty(ccrDtoList)}">
                                                    	<!-- 채팅방 -->
                                                    	<th:block th:each="ccrDto, ccrDtoStat : ${ccrDtoList}">
		                                                    <a href="javascript:void(0)"
		                                                    	onclick="enterChatRoom(this);"
		                                                        class="message-item d-flex align-items-center border-bottom px-3 py-2">
		                                                        <input type="hidden" th:value="${ccrDto.room_no}">
		                                                        <div class="user-img"><img th:src="@{'/UploadImg/employee/' + ${ccrDto.room_pic}}" 
		                                                                alt="user" class="img-fluid rounded-circle" 
		                                                                style="aspect-ratio: 1/1; object-fit: cover;" 
		                                                                width="40px"> <span
		                                                                class="profile-status busy float-right"></span>
		                                                        </div>
		                                                        <div class="w-75 d-inline-block v-middle pl-2">
		                                                            <h6 class="message-title mb-0 mt-1" th:text="${ccrDto.room_name}"></h6>
		                                                            <span class="font-12 text-nowrap d-block text-muted text-truncate" 
		                                                            th:text="${ccrDto.last_chat}"></span>
		                                                            <span class="font-12 text-nowrap d-block text-muted" 
		                                                            th:text="${ccrDto.last_time}"></span>
		                                                        </div>
		                                                    </a>
                                                    	</th:block>
                                                    </th:block>
                                                    
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- 개설된 채팅방 목록 끝 -->
                                </div>
                                <!--채팅방 목록 끝 -->
                                <!-- 채팅방 상세 시작 -->
                                <div class="col-lg-9">
                                <div id="chat_container">
                                	<div th:fragment="chatContainer">
	                                	<th:block th:if="${roomName != null and !roomName.isEmpty()}">
		                                	<div class="card-body border">
		                                        <div class="row">
		                                            <div class="col-12">
		                                                <div class="input-field mt-0 mb-0">
		                                                    <input id="room_name" th:value="${roomName}"
		                                                        class="form-control border-0" type="text">
	                                                        <input type="hidden" id="thisRoomNo" th:value="${roomNo}">
		                                                </div>
		                                            </div>
		                                        </div>
		                                    </div>
	                                	</th:block>
	                                    <div class="chat-box scrollable position-relative" id="messageContainer"
	                                        style="height: 70vh;">
	                                        <!-- 전체 채팅 리스트 시작 -->
	                                        <ul class="chat-list list-style-none px-3 pt-3">
	                                        	<!-- 채팅 컨텐츠 시작 -->
	                                        	<th:block th:if="${#lists.isEmpty(combinedList)}">
	                                        		<li class="chat-item odd list-style-none mt-3">
	                                                <div class="chat-content text-center d-inline-block pl-3">
	                                                    <div class="box msg p-2 d-inline-block mb-1" 
	                                                    style="background-color:transparent !important;">
	                                                    	대화를 시작하세요.
	                                                    </div>
	                                                </div>
	                                            </li>
	                                        	</th:block>
	                                        	<th:block th:if="${!#lists.isEmpty(combinedList)}">
	                                        		<th:block th:each="chat, chatStat : ${combinedList}">
		                                            	<!-- 챗 타입이 사용자 -->
		                                            	<th:block th:if="${chat.type.equals('me')}">
			                                                 <li class="chat-item odd list-style-none mt-3">
			                                                 	<!-- 대화내용 -->
				                                                <div class="chat-content text-right d-inline-block pl-3">
				                                                    <div class="box msg p-2 d-inline-block mb-1" 
				                                                    th:text="${chat.content}"></div>
				                                                </div>
				                                                <!-- 작성시간 -->
				                                                <div class="chat-time text-right d-block font-10 mt-1 mr-0 mb-3" 
				                                                th:text="${chat.timestamp}"></div>
				                                            </li>
		                                            	</th:block>
		                                            	<!-- 챗 타입이 사용자가 아님 -->
		                                            	<th:block th:if="${chat.type.equals('notMe')}">
		                                            		<li class="chat-item list-style-none mt-3">
		                                            			<!-- 사진 -->
				                                                <div class="chat-img d-inline-block">
				                                                	<img th:src="@{'/UploadImg/employee/' + ${chat.profilePic}}" alt="user"
				                                                        class="rounded-circle" 
				                                                        style="aspect-ratio: 1/1; object-fit: cover;" 
				                                                        width="50">
				                                                </div>
				                                                <div class="chat-content d-inline-block pl-3">
				                                                	<!-- 이름 -->
				                                                    <h6 class="font-weight-medium" th:text="${chat.writer_name}"></h6>
			                                                    	<!-- 대화내용 -->
				                                                    <div class="msg p-2 d-inline-block mb-1" 
				                                                    th:text="${chat.content}"></div>
				                                                </div>
				                                                <!-- 작성시간 -->
				                                                <div class="chat-time d-block font-10 mt-1 mr-0 mb-3" 
				                                                th:text="${chat.timestamp}"></div>
				                                            </li>
		                                            	</th:block>
		                                            	<!-- 챗 타입이 상태이력 -->
		                                            	<th:block th:if="${chat.type.equals('history')}">
			                                                <li class="chat-item list-style-none mt-3">
			                                                 	<!-- 이력내용 -->
				                                                <div class="chat-content text-center d-inline-block pl-3">
				                                                    <div class="box msg p-2 d-inline-block mb-1" 
				                                                    style="background-color:transparent !important;">
				                                                    	<div th:switch="${chat.content}">
					                                                    	<span th:text="${chat.writer_name}"></span>님이 
																            <span th:case="1">입장 하셨습니다.</span>
																            <span th:case="2">퇴장 하셨습니다.</span>
																            <span th:case="3">초대 되었습니다.</span>
																            <span th:case="4">강퇴 되었습니다.</span>
																            <span th:case="*">알 수 없음</span>
																        </div>
			                                                    	</div>
				                                                </div>
				                                            </li>
		                                            	</th:block>
	                                        		</th:block>
	                                        	</th:block>
	                                        	<!-- 채팅 컨텐츠 끝 -->
	                                        </ul>
	                                        <!-- 전체 채팅 리스트 끝 -->
	                                    </div>
                                	</div>
                               	</div>   
                                <div class="card-body border-top">
                                    <div class="row">
                                        <div class="col-9">
                                            <div class="input-field mt-0 mb-0">
                                                <input id="messageInput" placeholder="대화를 입력하세요."
                                                    class="form-control border-0" type="text">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <a class="btn-circle btn-lg btn-cyan float-right text-white" id="sendButton" 
                                                href="javascript:void(0)"><i class="fas fa-paper-plane"></i></a>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <!-- 채팅방 상세 끝 -->
                            </div>
                            <!--채팅방 목록 + 채팅창 끝 -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- footer -->
            <!-- ============================================================== -->
            <footer class="footer text-center pt-0">
                All Rights Reserved by Adminmart. Designed and Developed by <a
                    href="https://wrappixel.com">WrapPixel</a>.
            </footer>
            <!-- ============================================================== -->
            <!-- End footer -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Page wrapper  -->
        <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- This page JavaScript -->
    <!-- ============================================================== -->
	<script type="text/javascript">
		
		// 전송 버튼 클릭 이벤트 설정
	    const sendButton = document.getElementById("sendButton");

        sendButton.addEventListener("click", function() {
        	if (messageInput.value.trim() !== '') {
                sendMessage(); // 메시지 전송 함수 호출
            } else{
            	alert("텍스트를 입력하세요.");
            }
        });

	    // Enter 키로 메시지 전송
	    const messageInput = document.getElementById("messageInput");

        messageInput.addEventListener("keypress", function(event) {
        	
        	
        	// 입력 필드 값이 null이 아니고 빈 문자열이 아닐 때
            if (event.key === 'Enter' && messageInput.value.trim() !== '') {
            	sendMessage(); // 메시지 전송 함수 호출
            } else{
            	alert("텍스트를 입력하세요.");
            }
        });

        
		// 메시지를 전송하는 함수
		function sendMessage() {
			// csrf토큰
			const csrfToken = document.getElementById("csrf_token").value;
			// 메세지 내용
		    const msg = document.getElementById("messageInput").value;
			// 메세지를 보낸 방번호 
			const roomNo = document.getElementById("thisRoomNo").value;
		    
			fetch(`/chatmsg/${roomNo}`,{
				method:'POST',
				headers:{
					'Content-Type': 'application/json',
		            "X-CSRF-TOKEN": csrfToken
				},
				body: JSON.stringify({
					chat_content: msg,
					room_no: roomNo
				})
			})
			.then(response => response.json())
		    .then(data => {
		    	if (data.res_code == '200') {
					// 채팅방 목록 갱신
		        	loadChatroom(roomNo);
			    	// 작성 채팅 초기화
		        	document.getElementById('messageInput').value = "";
		    	} else {
		            Swal.fire({
		                icon: 'error',
		                title: '실패',
		                text: data.res_msg
		            });
		        }
			})
		}

		
		// 채팅방 목록을 클릭하여 채팅방 입장
		function enterChatRoom(element){
			
			const roomNo = element.querySelector('input[type="hidden"]').value;
			loadChatroom(roomNo);
			sendRoomNoInfo(roomNo);
			
		}
		
		// 채팅방 목록 불러오기, 갱신하기
		function loadChatroom(roomNo){
			// csrf토큰
			const csrfToken = document.getElementById("csrf_token").value;
			
			fetch(`/chatrooms/${roomNo}`,{
				method:'GET',
				headers:{
					'X-CSRF-TOKEN': csrfToken // CSRF 토큰 추가
				}
			})
			.then(response => response.text())
			.then(fragment=>{
				// 가져온 HTML 프래그먼트를 파싱하여 DOM에 삽입
		        document.getElementById('chat_container').innerHTML = fragment;
				// 메시지가 로드된 후 스크롤을 아래로 이동
	            scrollToBottom();
			})
		}
		
		// 웹소켓으로 채팅방 정보 전송
		function sendRoomNoInfo(roomNo) {
		    // WebSocket 연결이 열려 있는 경우에만 정보 전송
		    if (socket && socket.readyState === WebSocket.OPEN) {
		        socket.send(JSON.stringify({
		            type: "ROOM_NO", // 메시지 타입
		            roomNo: roomNo   // 현재 페이지 경로 정보
		        }));
		    }
		}
		
		// 스크롤 최하단으로 고정
		function scrollToBottom() {
		    const chatContainer = document.getElementById('messageContainer'); // 채팅 메시지를 출력하는 요소의 ID
		    chatContainer.scrollTop = chatContainer.scrollHeight; // 스크롤을 최하단으로 설정
		}
	</script>
    <!-- ============================================================== -->
    <!-- end page JavaScript -->
    <!-- ============================================================== -->
</body>

</html>