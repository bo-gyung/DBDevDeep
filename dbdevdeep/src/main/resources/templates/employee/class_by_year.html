<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{include/employee_layout}">
<th:block layout:fragment="content">
	<style>
		/* datatable css */
		div.dataTables_wrapper div.dataTables_paginate ul.pagination {
			margin: 2px 0; white-space: nowrap; justify-content: center; margin-top: 8px;
		}
		/* 첫 번째 td를 수평 및 수직 가운데 정렬 */
		.bordered tbody tr td.align-center {
			text-align: center; /* 수평 가운데 정렬 */ vertical-align: middle; padding-bottom: 8px;
		}
		
		/* 정렬 아이콘의 위치 및 정렬 설정 */
		table.dataTable thead .sorting:before, table.dataTable thead .sorting:after, table.dataTable thead .sorting_asc:before, table.dataTable thead .sorting_asc:after, table.dataTable thead .sorting_desc:before, table.dataTable thead .sorting_desc:after, table.dataTable thead .sorting_asc_disabled:before, table.dataTable thead .sorting_asc_disabled:after, table.dataTable thead .sorting_desc_disabled:before, table.dataTable thead .sorting_desc_disabled:after {
			display: inline-block; /* 아이콘을 인라인 블록으로 설정 */ position: relative; /* 아이콘 위치를 텍스트 옆으로 설정 */ margin-left: 10px !important; /* 텍스트와 아이콘 사이의 간격을 조정 */ bottom: 0; /* 아이콘을 텍스트 높이에 맞추기 위해 위치 설정 */ opacity: 0.7; /* 아이콘의 불투명도 설정 */ content: ''; /* 정렬 아이콘을 CSS로 설정 */
		}
		
		table.dataTable thead .sorting:after, table.dataTable thead .sorting_asc:after, table.dataTable thead .sorting_desc:after, table.dataTable thead .sorting_asc_disabled:after, table.dataTable thead .sorting_desc_disabled:after {
			content: "\25BC"; /* 아래쪽 화살표 */
		}
		
		/* 정렬 아이콘 활성화 시 스타일 */
		table.dataTable thead .sorting_asc:after {
			content: "\25B2"; /* 위쪽 삼각형 화살표 */
		}
		
		table.dataTable thead .sorting_desc:after {
			content: "\25BC"; /* 아래쪽 삼각형 화살표 */
		}
		
		.filter {
			border-collapse: separate; border-spacing: 0; width: 100%;
		}
		
		.pad {
			height: 5px; background: none;
		}
		
		.filter tr {
			background-color: #e9ecef; border-radius: 50px;
		}
		
		.filter td, th {
			padding: 8px;
		}
		
		.filter th {
			border-bottom-left-radius: 5px; border-top-left-radius: 5px; padding-left: 20px;
		}
		
		.filter td:last-child {
			border-bottom-right-radius: 5px; border-top-right-radius: 5px; padding-right: 20px;
		}
		
		.filter input[type="checkbox"] {
			border: 1px solid #e9ecef; width: 16px; height: 16px; margin: 0px 5px; cursor: pointer;
		}
		
		.filter label {
			display: flex; align-items: center; margin: 0px auto; cursor: pointer;
		}
	</style>
	<div class="page-wrapper">
		<div class="container-fluid">
			<div class="row">
				<div class="col-12">
					<div class="card">
						<div class="card-body" style="padding: 50px;">
							<div class="col d-flex justify-content-start align-items-center" style="padding-left: 0px; max-width: 300px;">
								<div style="font-size: 30px;">학년도 별 반배정</div>
							</div>
								<div class="mt-4">
									<div class="row">
										<div class="col-md-4">
											<table class="filter" style="width: 80%;">
												<tr>
													<th><strong>직급</strong></th>
													<td><label><input type="checkbox" class="filter-assign" value="전체"> 전체</label></td>
													<td><label><input type="checkbox" class="filter-assign" value="미배정"> 미배정</label></td>
													<td><label><input type="checkbox" class="filter-assign" value="배정완료"> 배정완료</label></td>
												</tr>
											</table>
										</div>
										<div class="col-md-8 d-flex justify-content-end">
											<button type="button" class="btn waves-effect waves-light btn-primary m-1" data-toggle="modal" data-target="#class_create_modal">반 생성</button>
										</div>
									</div>
								</div>
							<div class="table-responsive">
								<table id="class_by_year" class="table table-hover table-bordered no-wrap" style="width: 100%">
									<thead>
										<tr>
											<th scope="col">번호</th>
											<th scope="col">학년도</th>
											<th scope="col">배정여부</th>
										</tr>
									</thead>
									<tbody>
										<th:block th:if="${#lists.isEmpty(resultList)}">
											<tr>
												<td colspan="7">반 배정 목록이 없습니다.</td>
											</tr>
										</th:block>
										<th:block th:if="${!#lists.isEmpty(resultList)}">
											<tr th:each="history, historyStat : ${resultList}" th:data-th="${history.t_year}" class="class_by_year" style="cursor: pointer;">
												<td scope="row" th:text="${historyStat.count}"></td>
												<td th:text="${history.t_year + ' 학년도'}"></td>
												<td th:text="${history.total - history.is_assign == 0 ? '배정완료' : '미배정(' + (history.total - history.is_assign) + ')'}"></td>
											</tr>
										</th:block>
									</tbody>
								</table>

							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- 반 생성 모달창 -->
			<div id="class_create_modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header modal-colored-header bg-info">
							<h4 class="modal-title" id="info-header-modalLabel">반 생성</h4>
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						</div>
						<div class="modal-body">
							<div class="text-center">생성하실 반 개수를 선택해주세요</div>
							<hr>
							<form class="pl-3 pr-3" id="gradeForm">
								<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
								<div class="form-group">
									<label for="t_year">학년도 <span style="color: red;">*</span></label> <select id="t_year" name="t_year" class="form-control">

									</select>
								</div>
								<div id="gradeDiv"></div>
								<div class="col-12 d-flex justify-content-end">
									<button type="button" class="btn waves-effect waves-light btn-light m-1" data-dismiss="modal" aria-hidden="true">취소</button>
									<button type="button" class="btn waves-effect waves-light btn-primary m-1" id="createClass">반 생성</button>
								</div>
							</form>


						</div>
					</div>
					<!-- /.modal-content -->
				</div>
				<!-- /.modal-dialog -->
			</div>
			<!-- /.modal -->
		</div>
		<footer class="footer text-center text-muted">
			All Rights Reserved by Adminmart. Designed and Developed by <a href="https://wrappixel.com">WrapPixel</a>.
		</footer>
	</div>
	<script>
        // 현재 년도를 기준으로 100년 전부터 10년 후까지의 년도 선택
        const startYear = new Date().getFullYear() - 100;
        const endYear = new Date().getFullYear();
        const selectElement = document.getElementById('t_year');

        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            selectElement.appendChild(option);
        };
 

        // 각 학년에 대한 입력 필드를 동적으로 생성합니다.
        for (let i = 1; i <= 6; i++) {
            const div = document.createElement('div');
            div.className = 'form-group';

            const label = document.createElement('label');
            label.setAttribute('for', `grade_${i}`);
            label.textContent = `${i}학년`;
            
            const span = document.createElement('span');
            span.textContent = ` *`;
            span.style.color = 'red';
            
            label.appendChild(span);

            const input = document.createElement('input');
            input.className = 'form-control';
            input.type = 'number'; // 숫자만 입력받을 수 있도록 설정
            input.id = `grade_${i}`;
            input.name = `grade_${i}`;
            input.setAttribute('min', '0'); // 0 이상의 숫자만 입력 가능
            input.setAttribute('max', '9'); // 최대 10까지
            
            input.addEventListener('input', function() {
                const value = this.value;
                if (value > 9) {
                    this.value = value.slice(0, 1);
                } else if(value < 0){
                	this.value = value.slice(0, 0);
                }
            });

            div.appendChild(label);
            div.appendChild(input);
            document.getElementById("gradeDiv").appendChild(div);
        }
        
        document.getElementById('createClass').addEventListener('click', () => {
        	const form = document.getElementById('gradeForm');
            const csrfToken = document.getElementById("csrf_token").value;
            const payload = new FormData(form);
            
            const obj = {};
            payload.forEach((value, key) => {
            	obj[key] = value;
            });
            const jsonData = JSON.stringify(obj);
            
            fetch('/grade-class', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify(obj)
            })
            .then(response => response.json())
            .then(data => {
                if (data.res_code === "200") {
                    Swal.fire({
                        icon: 'success',
                        title: '성공',
                        text: data.res_msg,
                        confirmButtonText: "닫기"
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '실패',
                        text: data.res_msg,
                        confirmButtonText: "닫기"
                    });
                }
            })
            .catch(error => console.error('Error:', error));
        });
        
        
        
    </script>


			<script>
				$(document).ready(function() {
					var table = $('#class_by_year').DataTable();
	
					// 필터링 함수
					function filterTable() {
						var assignFilters = [];
	
						$('.filter-assign:checked').each(
								function() {
									assignFilters.push($(this).val());
								});
	
	
						table.column(2).search(
								assignFilters.join('|'), true,
								false).draw();
					}
	
					// 체크박스 변경 이벤트
					$('.filter-assign').on('change', function() {
						
						if ($(this).hasClass('filter-assign') && $(this).val() === '전체') {
							if ($(this).is(':checked')) {
								$('.filter-assign').not('.filter-assign[value="전체"]').prop('checked', true);
							} else {
								$('.filter-assign').not('.filter-assign[value="전체"]').prop('checked', false);
							}
						}
						
						
						// 필터 적용
						filterTable();
					});
	
					// 초기 필터링
					filterTable();
				});
			</script>
	</body>
</html>