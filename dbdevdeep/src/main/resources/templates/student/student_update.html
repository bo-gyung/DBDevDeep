<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{include/student_layout}">
<th:block layout:fragment="content">
<style>
	.addPic {
	background-color: gainsboro;
	width: 100%;
	aspect-ratio: 1/1;
	border-radius: 50%;
	border: none;
	font-size: 25px;
	}
	
	.addPic, .littleButton {
		transition: background-color 0.3s ease;
	}
	
	.addPic:hover, .littleButton:hover {
		background-color: rgb(189, 189, 189);
		cursor: pointer;
	}
	
	.littleButton {
		background-color: gainsboro;
		width: 35px;
		height: 35px;
		border-radius: 50%;
		border: none;
		font-size: 15px;
		text-align: center;
		position: relative;
		bottom: 35px;
		left: 85px;
	}
	
	.preview-container {
		border-radius: 50%;
		overflow: hidden;
		width: 100%;
		aspect-ratio: 1/1;
		display: flex;
		align-items: center;
		justify-content: center;
		border: 2px solid lightgray;
	}
	
	#imagePreview {
		width: 100%;
		aspect-ratio: 1/1;
		object-fit: cover;
	}
	
	.hidden {
		display: none;
	}
</style>
	<body>
<div class="page-wrapper">
		<div class="container-fluid">
			<div class="col-sm-12 col-md-12">
				<div class="card">
					<div class="card-body" style="padding: 50px;">
						<div class="col d-flex justify-content-start align-items-center" style="padding-left: 0px; max-width: 300px;">
									<div style="font-size: 30px;">학생 정보 수정</div>
								</div>
								<hr>
						<form id="student_update_form">
							<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
							<div class="form-body">
								<div class="row">
									<div class="col-md-1 "></div>


									<!-- 사진등록 -->
									<div class="col-md-1 ">
										<div class="form-group" style="margin-top: 20px;">
											<label>사진</label>
											<div class="row">
												<div class="preview-container hidden" id="preview-container">
													<th:block th:if="${dto != null && dto.student_new_pic != null}">
														<img id="imagePreview" th:src="@{'/UploadImg/student/' + ${dto.student_new_pic}}">
													</th:block>
													<th:block th:unless="${dto != null && dto.student_new_pic != null}">
														<img id="imagePreview">
													</th:block>
												</div>
												<input type="button" class="addPic" id="addPic" value="+">
											</div>
										</div>
									</div>

									<div class="col-md-9 m-auto">
										<div class="form-group">
										<input type="hidden" name="student_no" th:value="${dto.student_no}">
											<label for="name">이름 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<input class="form-control" type="text" id="name" name="student_name" th:value="${dto.student_name}">
												</div>
											</div>
										</div>

										<div class="form-group">
											<label for="student_status">재학 여부 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<select class="form-control" id="student_status" name="student_status" th:value="${dto.student_status}">
									                        <option value="재학">재학</option>
									                        <option value="휴학">휴학</option>
									                        <option value="전학">전학</option>
									                        <option value="졸업">졸업</option>
									                        <option value="퇴학">퇴학</option>
									                </select>
												</div>
											</div>
										</div>
										
										<div class="form-group">
											<label for="student_birth">생년월일 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<input class="form-control" type="date" name="student_birth" id="student_birth" th:value="${dto.student_birth}">
												</div>
											</div>
										</div>
										
										<div class="form-group">
											<label for="zipcode">우편번호 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<input class="form-control" type="text" id="zipcode" name="student_post_code" th:value="${dto.student_post_code}">
												</div>
												<div class="col-md-1">
		                    						<input type="button" id="student_location" value="우편번호 찾기" class="btn waves-effect waves-light btn-primary">
												</div>
											</div>
										</div>
										
										<div class="form-group">
											<label for="student_address">주소 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<input class="form-control" type="text" id="student_address" name="student_addr" th:value="${dto.student_addr}">
												</div>
											</div>
										</div>
										
										<div class="form-group">
											<label for="address-detail">상세주소 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-8">
													<input class="form-control" type="text" id="address-detail" name="student_detail_addr" th:value="${dto.student_detail_addr}">
												</div>
											</div>
										</div>
										
										
										<div class="form-group">
											<label for="phone">전화번호 <span style="color: red;">*</span></label>
											<div class="row">
												<div class="col-md-2">
													<input class="form-control" type="text" id="sp1" maxlength="3" th:value="${dto.student_phone.split('-')[0]}">
												</div>
												<div class="col-md-3">
													<input class="form-control" type="text" id="sp2" maxlength="4" th:value="${dto.student_phone.split('-')[1]}">
												</div>
												<div class="col-md-3">
													<input class="form-control" type="text" id="sp3" maxlength="4" th:value="${dto.student_phone.split('-')[2]}">
												</div>
												<input type="hidden" name="student_phone" id="student_phone">
											</div>
										</div>
										
										
										<div class="form-group">
											<label>성별</label>
											<div class="row">
												<div class="col-md-8">
													<input type="radio" id="male" name="student_gender" value="M" th:checked="${dto.student_gender=='M'}"> 남자&nbsp;&nbsp;
			                    					<input type="radio" id="female" name="student_gender" value="W" th:checked="${dto.student_gender=='W'}"> 여자
												</div>
											</div>
										</div>
										<div class="form-group">
											<div class="row">
												<div class="col-md-8"></div>
												<div class="col-md-2">
													<br> 
													<input type="button" onclick="cancelBtn();" class="btn waves-effect waves-light btn-light" value="취소">
													<input type="submit" class="btn waves-effect waves-light btn-primary" value="수정"> 
												</div>
											</div>
										</div>
										<input type="file" class="custom-file-input" id="inputGroupFile04" name="file">
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- ============================================================== -->
		<!-- End PAge Content -->
		<!-- ============================================================== -->
		<!-- ============================================================== -->
		<!-- Right sidebar -->
		<!-- ============================================================== -->
		<!-- .right-sidebar -->
		<!-- ============================================================== -->
		<!-- End Right sidebar -->
		<!-- ============================================================== -->
	</div>
		<script src="/assets/libs/jquery/dist/jquery.min.js"></script>
		<script src="/assets/libs/popper.js/dist/umd/popper.min.js"></script>
		<script src="/assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="/dist/js/app-style-switcher.js"></script>
		<script src="/dist/js/feather.min.js"></script>
		<script
			src="/assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
		<script src="/assets/extra-libs/sparkline/sparkline.js"></script>
		<script src="/dist/js/sidebarmenu.js"></script>
		<script src="/dist/js/custom.min.js"></script>
		<script
			src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
	  	const cancelBtn = () => {
	  		window.location.href = '[[${'/student/' + dto.student_no}]]';
	  	}
	</script>	
	<script>
		window.onload = function(){
		    document.getElementById("student_location").addEventListener("click", function(){ //주소입력칸을 클릭하면
		        //카카오 지도 발생
		        new daum.Postcode({
		            oncomplete: function(data) { //선택시 입력값 세팅
		                document.getElementById("zipcode").value = data.zonecode;
		                document.getElementById("student_address").value = data.address; // 주소 넣기
		            }
		        }).open();
		    });
		}
	</script>


	<script>
		window.onload = function(){
			const form=document.getElementById("student_update_form");
			form.addEventListener('submit',(e)=>{
				e.preventDefault();
				const phone1 = document.getElementById('sp1').value;
			    const phone2 = document.getElementById('sp2').value;
			    const phone3 = document.getElementById('sp3').value;
			    const fullPhoneNumber = `${phone1}-${phone2}-${phone3}`;
			    document.getElementById('student_phone').value = fullPhoneNumber;
			    
				let vali_check = false;
				let vali_text = "";
				if(form.student_name.value == ""){
					vali_text += "학생 이름을 입력하세요.";
					form.student_name.focus();
				} else if(form.student_birth.value == ''){
					vali_text += "생년월일을 입력하세요";
					form.student_birth.focus();
				} else if(form.student_post_code.value == ''){
					vali_text += '우편번호를 입력하세요';
					form.student_post_code.focus();
				} else if(form.student_addr.value == ''){
					vali_text += '주소를 입력하세요';
					form.student_addr.focus();
				}else if(form.student_detail_addr.value == ''){
					vali_text += '상세주소를 입력하세요';
					form.student_detail_addr.focus();
				}else if(document.getElementById('sp1').value == "") {
				    vali_text += "전화번호를 입력하세요";
				    document.getElementById('sp1').focus();
				}else if(document.getElementById('sp2').value == "") {
				    vali_text += "전화번호를 입력하세요";
				    document.getElementById('sp2').focus();
				}else if(document.getElementById('sp3').value == "") {
				    vali_text += "전화번호를 입력하세요";
				    document.getElementById('sp3').focus();
				}else if(!form.student_gender.value){
					vali_text += '성별을 선택하세요';
				}else{
					vali_check = true;
				}
			    
				if(vali_check == false){
					alert(vali_text);
				}else{
					const payload = new FormData(form);
					const csrfToken = document.getElementById('csrf_token').value;
					const studentNo = form.student_no.value;
					fetch('/student/'+studentNo,{
						method:'post',
						headers : {
							'X-CSRF-TOKEN':csrfToken
						},
						body:payload
					})
					.then(response => response.json())
					.then(data=>{
						if(data.res_code == '200'){
							Swal.fire({
								icon : 'success',
								title : '성공',
								text : data.res_msg
							}).then((result)=>{
								location.href = "/student/"+studentNo;
							});
						}else{
							Swal.fire({
								icon : 'error',
								title : '실패',
								text : data.res_msg
							});
						}
						
					})
				}
			
			});
		};
	</script>
	<script>
		    const fileInput = document.getElementById('inputGroupFile04');
		    const imagePreview = document.getElementById('imagePreview');
		    const addPicButton = document.getElementById('addPic');
		    const previewContainer = document.getElementById('preview-container');
	
		    /* const ext = imagePreview.src; */
		    
		    // 기본 이미지 경로나 "이미지 없음" 메시지
		    const defaultImageSrc = imagePreview.src == "" ? '/assets/images/noprofile.png' : imagePreview.src; // 기본 이미지 경로 (없으면 빈 문자열도 가능)
		    
	
		    // imagePreview 요소가 존재하는지 확인
		    if (imagePreview) {
		        // DTO에 student_new_pic 값이 있는 경우 이미지 미리보기 설정
		        const existingImageSrc = imagePreview.dataset.existingImage;  // data 속성으로 전달된 기존 이미지 경로
	
		        if (existingImageSrc) {
		            imagePreview.src = existingImageSrc;  // 기존 이미지를 미리보기로 설정
		            addPicButton.classList.add('littleButton');  // 이미지가 있는 경우 버튼 스타일 변경
		            previewContainer.classList.remove('hidden');
		        } else {
		            imagePreview.src = defaultImageSrc;  // 기본 이미지를 설정하거나 "이미지 없음" 처리
		            /* previewContainer.classList.add('hidden'); */
		        }
	
		        // 파일 업로드 이벤트 처리
		        addPicButton.addEventListener('click', () => {
		            fileInput.click();
		        });
	
		        fileInput.addEventListener('change', (event) => {
		            const file = event.target.files[0];
	
		            if (file) {
		                const validExtensions = ['jpg', 'jpeg', 'png', 'jfif'];
		                const fileExtension = file.name.split('.').pop().toLowerCase();
	
		                if (validExtensions.includes(fileExtension)) {
		                    const reader = new FileReader();
	
		                    reader.onload = (e) => {
		                        imagePreview.src = e.target.result;  // 선택한 파일을 이미지로 미리보기
		                        addPicButton.classList.remove('addPic');
		                        addPicButton.classList.add('littleButton');
		                        previewContainer.classList.remove('hidden');
		                    };
	
		                    reader.readAsDataURL(file);  // 파일을 읽어서 데이터 URL로 변환
		                } else {
		                    Swal.fire({
		                        icon: 'error',
		                        title: '실패',
		                        text: '이미지 파일만 선택할 수 있습니다.',
		                        confirmButtonText: "닫기"
		                    });
		                    fileInput.value = ''; 
		                    imagePreview.src = defaultImageSrc;  // 기본 이미지로 재설정
		                }
		            } else {
		                imagePreview.src = defaultImageSrc;  // 기본 이미지로 재설정
		            }
		        });
		    } else {
		        console.error("imagePreview element not found!");
		    }
		
	</script>	
	</body>
</html>