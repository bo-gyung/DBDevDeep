<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{include/student_layout}">
<head>
	<link href="/dist/css/style.min.css" rel="stylesheet">
<style>
    /* 테이블 스타일 */
    table {
        width: 100%;
        border-collapse: collapse; /* 테두리가 겹치지 않도록 설정 */
    }

    th, td {
        border: 2px solid black; /* 테두리 두께 및 색상 */
        padding: 8px;
        text-align: center;
    }
	.custom-cancel-button{
		color: black !important;
	}
	
	.swal-custom-button {
	  background-color: #0031AE !important;
	  color: white; /* 버튼 텍스트 색상 */
	  border: none; /* 버튼 테두리 제거 */
	  padding: 10px 20px; /* 버튼 패딩 */
	  font-size: 16px; /* 버튼 폰트 크기 */
	  cursor: pointer; /* 마우스 커서 포인터 */
	}
	
	.swal-custom-button:hover {
	  background-color: #002685 !important;
	}
</style>
</head>
<th:block layout:fragment="content">
<body>
<input type="hidden" id="subject_no" th:value="${subject.subject_no}">
		<div class="page-wrapper">
			<div class="container-fluid" style="margin-bottom:-10px;">
				<div class="col-sm-12 col-md-12">
                        <div class="card">
					<div class="card-body" style="padding: 50px 80px;">
					
					<div class="row d-flex justify-content-between" style="margin-left:0px !important; margin-right:0px !important;">
	                    <div class="d-flex align-items-center" style="padding-right:0px; max-width:250px;">
	                        <div style="font-size:30px; color:black;">과목 성적 등록</div>
	                    </div>			
	                    <div class="d-flex  align-items-center">
							<button id="download_excel" class="btn btn-info">엑셀로 받기</button>
						</div>
					</div>
					<br>	
					<th:block th:if="${username == subject.teacher_history.getEmployee().getEmpId()}">
			            <form id="score_register_subject_form" method="post">
			            <input type="hidden" id="csrf_token" th:value="${_csrf.token}">
			            	<table>
						        <thead>
								    <!-- 교육과정 정보가 없을 때 -->
								    <th:block th:if="${#lists.isEmpty(curriList)}">
								        <tr>
								            <th rowspan="2">번호</th>
								            <th rowspan="2">이름</th>
								            <td colspan="3">교육과정 정보가 없습니다.</td>
								        </tr>
								    </th:block>
								
								    <!-- 교육과정 정보가 있을 때 -->
								    <th:block th:if="${!#lists.isEmpty(curriList)}">
								        <tr>
								            <th rowspan="2">번호</th>
								            <th rowspan="2">이름</th>
								            <!-- curriculumList의 content 반복 -->
								            <th th:each="curri : ${curriList}" th:text="${curri.curriculum_content}" colspan="3"></th>
								        </tr>
								        <tr>
								            <!-- 반영비율, 과목만점, 점수 반복해서 생성 -->
								            <th:block th:each="curri : ${curriList}">
								                <th>반영비율(%)</th>
								                <th>과목만점</th>
								                <th>점수</th>
								            </th:block>
								        </tr>
								    </th:block>
								</thead>
						        <tbody>
								   <tr th:each="studentClass, stat : ${resultList}">
							            <td th:text="${studentClass.student_id}"></td> <!-- 번호 -->
							            <td th:text="${studentClass.student.studentName}"></td> <!-- 이름 -->
									<th:block th:each="curri : ${curriList}">
								        <td th:text="${curri.curriculum_ratio}+'%'"></td>
								        <td th:text="${curri.curriculum_max_score}+'점'"></td>
								        <td>
								        	<input type="hidden" th:value="${curri.curriculum_no}" name="curriculum_no">
						                    <input type="hidden" th:value="${studentClass.student_no}" name="student_no">
						                    <input type="text" style="width: 100px;" name="score" id="score" 
						                   th:value="${(scoreList != null && scoreList.get(studentClass.student_no) != null) ? 
						                     (scoreList.get(studentClass.student_no).get(curri.getCurriculum_no) != null ? 
						                     scoreList.get(studentClass.student_no).get(curri.getCurriculum_no) : '') : ''}">
								        </td>
								    </th:block>
					
								</tbody>
						    </table>
						    <br>
						    <div class="row">
						    <div class="col d-flex justify-content-end align-items-center">
								<br> 
								<input type="button" onclick="cancelBtn();" class="btn waves-effect waves-light btn-light m-1" value="취소">
								<input type="submit" class="btn waves-effect waves-light btn-primary m-1" style="margin-right:0 !important;" value="등록"> 
							</div>
							</div>
	            		</form>
	            		</th:block>
	            		<th:block th:if="${username != subject.teacher_history.getEmployee().getEmpId()}">
	            			<table>
						        <thead>
								    <!-- 교육과정 정보가 없을 때 -->
								    <th:block th:if="${#lists.isEmpty(curriList)}">
								        <tr>
								            <th rowspan="2">번호</th>
								            <th rowspan="2">이름</th>
								            <td colspan="3">교육과정 정보가 없습니다.</td>
								        </tr>
								    </th:block>
								
								    <!-- 교육과정 정보가 있을 때 -->
								    <th:block th:if="${!#lists.isEmpty(curriList)}">
								        <tr>
								            <th rowspan="2">번호</th>
								            <th rowspan="2">이름</th>
								            <!-- curriculumList의 content 반복 -->
								            <th th:each="curri : ${curriList}" th:text="${curri.curriculum_content}" colspan="3"></th>
								        </tr>
								        <tr>
								            <!-- 반영비율, 과목만점, 점수 반복해서 생성 -->
								            <th:block th:each="curri : ${curriList}">
								                <th>반영비율(%)</th>
								                <th>과목만점</th>
								                <th>점수</th>
								            </th:block>
								        </tr>
								    </th:block>
								</thead>
						        <tbody>
								   <tr th:each="studentClass, stat : ${resultList}">
							            <td th:text="${studentClass.student_id}"></td> <!-- 번호 -->
							            <td th:text="${studentClass.student.studentName}"></td> <!-- 이름 -->
									<th:block th:each="curri : ${curriList}">
								        <td th:text="${curri.curriculum_ratio}+'%'"></td>
								        <td th:text="${curri.curriculum_max_score}+'점'"></td>
								        <td th:text="${(scoreList != null && scoreList.get(studentClass.student_no) != null) ? 
						                     (scoreList.get(studentClass.student_no).get(curri.getCurriculum_no) != null ? 
						                     scoreList.get(studentClass.student_no).get(curri.getCurriculum_no) : '') : ''}">
								        	
								        </td>
								    </th:block>
					
								</tbody>
						    </table>
						    <br>
						    <input type="button" class="btn btn-outline-secondary m-1"  value="목록으로" th:onclick="|location.href='@{/student/score}'|">
	            		</th:block>
					</div>
            	</div>
				</div>
				</div>
				<footer class="footer text-center text-muted"> All Rights Reserved by Adminmart. Designed by DBDevDeep and Developed by WrapPixel.</footer>
		</div>
	
	<script src="/assets/libs/jquery/dist/jquery.min.js"></script>
	<script src="/assets/libs/popper.js/dist/umd/popper.min.js"></script>
	<script src="/assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="/dist/js/app-style-switcher.js"></script>
	<script src="/dist/js/feather.min.js"></script>
	<script src="/assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
	<script src="/assets/extra-libs/sparkline/sparkline.js"></script>
	<script src="/dist/js/sidebarmenu.js"></script>
	<script src="/dist/js/custom.min.js"></script>
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
	  	const cancelBtn = () => {
	  		window.location.href = '/student/score';
	  	}
	</script>
	<script>
	$(document).ready(function () {
	    // subjectNo 변수를 제대로 가져오는지 확인
	    const subjectNo = document.getElementById("subject_no").value;

	    $('#download_excel').on('click', function (e) {
	        e.preventDefault();  // 기본 버튼 동작을 막음
	        if (subjectNo) {
	            const url = '/excel/download/subject/' + subjectNo;  // subjectNo를 URL에 추가
	            window.location.href = url;  // 해당 URL로 요청하여 다운로드
	        } else {
	            alert("과목 번호를 찾을 수 없습니다.");
	        }
	    });
	});
	</script>
	<script>
	const form=document.getElementById("score_register_subject_form");
	form.addEventListener('submit',(e)=>{
		e.preventDefault();
		// 새로운 FormData 생성
	    const formData = new FormData(form);
	 	// scoreDtoList를 담을 배열 생성
	    let scoreDtoList = [];
	    var studentNo = document.getElementById("subject_no");
	 	
	 	// FormData에서 'score' 필드만 유효한 값만 필터링하여 처리
	    const scoreInputs = document.querySelectorAll('input[name="score"]');
	 	
	    scoreInputs.forEach(input => {
	        const scoreValue = input.value.trim();
	        
	        // curriculum_no와 student_no를 직접 가져옴
	        const curriculumNo = input.previousElementSibling.previousElementSibling.value;
	        const studentNo = input.previousElementSibling.value;

	        // scoreDto 객체 생성 후 배열에 추가 (빈 값도 포함)
	        let scoreDto = {
	            curriculum_no: curriculumNo,
	            student_no: studentNo,
	            score: scoreValue  // 빈 값도 전송
	        };
	        scoreDtoList.push(scoreDto);
	    });
	 	
		const csrfToken = document.getElementById('csrf_token').value;
		
			fetch('/score',{
				method:'POST',
				headers : {
					'X-CSRF-TOKEN':csrfToken,
					'Content-Type': 'application/json'
				},
				body:JSON.stringify(scoreDtoList) 
			})
			.then(response => response.json())
			.then(data=>{
				if(data.res_code == '200'){
					Swal.fire({
						icon : 'success',
						title : '성공',
						text : data.res_msg,
	                    confirmButtonText: '확인',
	                    customClass: {
	                        confirmButton: 'swal-custom-button'
	                    }
					}).then((result)=>{
						location.reload();
					});
				}else{
					Swal.fire({
						icon : 'error',
						title : '실패',
						text : data.res_msg,
	                    confirmButtonText: '확인',
	                    customClass: {
	                        confirmButton: 'swal-custom-button'
	                    }
					});
				}
			});
	});
	</script>
</body>

</html>
