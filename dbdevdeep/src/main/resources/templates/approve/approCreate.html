<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{include/approve_layout}">
     
<head>
    <!-- 꼭 필요한지 확인해 볼 것
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    Tell the browser to be responsive to screen width
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    Custom CSS
    <link href="dist/css/style.min.css" rel="stylesheet"> -->
     
     <!-- 
     Tree 가 사용하는 jQuery로 상위에 선언 되어야 tree 가 문제 없이 작동합니다. 아래에 jQuery 가 선언되어있으면 아래 코드 삭제 필요합니다.
     -->

    <script src="assets/libs/jquery/dist/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->
    <!-- Bootstrap -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- jsTree -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    
    
    
    <script>
        $(document).ready(function() {
        	let targetCellId;
        	$('#openTreeButton1').click(function () {
                targetCellId = '#selectedNodesTable1'; // 협의자 input ID로 변경
                $('#treeModal').modal('show');
                initializeTree();
            });

            // 결재자 버튼 클릭 시
            $('#openTreeButton2').click(function () {
                targetCellId = '#selectedNodesTable2'; // 결재자 셀 ID
                $('#treeModal').modal('show');
                initializeTree();
            });
            
            // 참조자 버튼 클릭시
            $('#openTreeButton3').click(function () {
                targetCellId = '#selectedNodesTable3'; // 참조자 셀 ID
                $('#treeModal').modal('show');
                initializeTree();
            });

            function initializeTree() {
                // 기존 jstree 인스턴스 제거
                $('#jstree_modal').jstree("destroy").empty();

                // jstree 초기화
                $('#jstree_modal').jstree({
                    'core': {
                        'data': [
                            { "text": "교장", "children": [
                                { "text": "교감", "children": [
                                    { "text": "교무부장", "children": [
                                        { "text": "1학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]},
                                        { "text": "2학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]},
                                        { "text": "3학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]},
                                        { "text": "4학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]},
                                        { "text": "5학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]},
                                        { "text": "6학년 교직원" ,"type": "non_selectable",  "children" : [
                                        	{ "text": "김철수"},
                                        	{ "text": "김영희"},
                                        	{ "text": "김철수"}
                                        ]}
                                    ]},
                                    { "text": "행정부장", "children": [
                                        { "text": "행정실 직원 1" },
                                        { "text": "행정실 직원 2" },
                                        { "text": "행정실 직원 3" }
                                        ]}
                                    ]}
                                ]}
                            ],
                            "check_callback": true
                    },
                    "plugins": ["checkbox", "types"], // 체크박스 플러그인 활성화
                    "types": {
                        "non_selectable": { // 선택 불가능한 노드 유형 정의
                            "select_node": false, // 노드 선택 비활성화
                            "a_attr": { "class": "jstree-disabled" }
                        }
                    },
                    "checkbox": {
                        "keep_selected_style": false, // 선택된 스타일 유지 안 함
                        "three_state": false, // 세 상태 트리 기능 비활성화
                        "cascade": "none" // 부모와 자식 간의 선택 상태 독립
                    }
                });
            }

         // 부모 노드 클릭 시 아무런 동작도 하지 않도록 설정
            $('#jstree_modal').on("select_node.jstree", function (e, data) {
                if (data.node.type === "non_selectable") {
                    data.instance.deselect_node(data.node); // 부모 노드 선택 해제
                }
            });

            // 확인 버튼 클릭 시 선택된 노드 처리
            $('#confirmSelection').click(function () {
                var selectedNodes = $('#jstree_modal').jstree("get_selected", true);
                var names = selectedNodes.map(function (node) { return node.text; });

                $(targetCellId).val(names.join(', ')); // 선택된 노드 이름을 input 필드에 추가
                $('#treeModal').modal('hide');
            });
        });
</script>
    
<![endif]-->
</head>
     
<th:block layout:fragment="content">

		<!-- ============================================================== -->
		<!-- End Left Sidebar - style you can find in sidebar.scss  -->
		<!-- ============================================================== -->
		<!-- ============================================================== -->
		<!-- Page wrapper  -->
		<!-- ============================================================== -->
		<div class="page-wrapper">
			<!-- ============================================================== -->
			<!-- Container fluid  -->
			<!-- ============================================================== -->
			<div class="container-fluid">
				<!-- ============================================================== -->
				<!-- Start Page Content -->
				<!-- ============================================================== -->
				<div class="col-sm-12 col-md-12">
					<div class="card">
						<div class="card-body">
							<h3 class="card-title">보낸 결재함</h3>
							<hr>
							
							<div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Start Page Content -->
                <!-- ============================================================== -->
                
                
                <div class="container">
        <form id="approCreateFrm">
        <h2 class="text-center">휴가 신청서</h2>
        
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <td>성명</td>
                    <td><input type="text" name="emp_name" th:value="${#authentication.principal.dto.emp_name}" readonly style="border: 0; outline: none;"></td>	
                    <td>부서</td>
                    <td><input type="text" name="dept_code" th:value="${#authentication.principal.dto.dept_name}" readonly style="border: 0; outline: none;"></td>
                </tr>
                <tr>
                    <td>직원번호</td>
                    <td><input type="text" name="emp_id" th:value="${#authentication.principal.dto.emp_id}" readonly style="border: 0; outline: none;"></td>
                    <td>직급</td>
                    <td><input type="text" name="job_code" th:value="${#authentication.principal.dto.job_name}" readonly style="border: 0; outline: none;"></td>
                </tr>
                <tr>
                	<td>제목</td>
                    <td colspan="3"><input type="text" class="form-control"></td>
                </tr>
                <tr>
                    <td>종류</td>
                    <td colspan="3">
                    <div style="display: flex; gap: 15px; justify-content: space-evenly; align-items: center;">
                        <div><label><input type="radio" name="vac_type" value="0" onclick="toggleHalfDay(false)"> 연차</label></div>
                        <div><label><input type="radio" name="vac_type" value="1" onclick="toggleHalfDay(true)"> 반차</label></div>
                        <div><label><input type="radio" name="vac_type" value="8" onclick="toggleHalfDay(false)"> 공가</label></div>
                        <div><label><input type="radio" name="vac_type" value="2" onclick="toggleHalfDay(false)"> 병가</label></div>
                        <div><label><input type="radio" name="vac_type" value="3" onclick="toggleHalfDay(false)"> 조퇴</label></div>
                        <div><label><input type="radio" name="vac_type" value="4" onclick="toggleHalfDay(false)"> 경조사</label></div>
                        <div><label><input type="radio" name="vac_type" value="5" onclick="toggleHalfDay(false)"> 출산휴가</label></div>
                        </div>
                    </td>
                </tr>
                <tr>
                	<td>일정</td>
                	<td><input type="datetime-local" id="datetime" class="form-control" name="start_date"><input type="datetime-local" class="form-control" name="end_date"></td>
                	<td>반차</td>
                	<td>
                	<div style="display: flex; gap: 15px; justify-content: space-evenly; align-items: center;">
                	<div><label><input type="radio" name="vac_type" value="6" id="half_one" disabled>오전</label></div>
                	<div><label><input type="radio" name="vac_type" value="7" id="half_two" disabled>오후</label></div>
                	</div>
                	</td>
                </tr>
                <tr>
                <td>신청사유</td>
                <td colspan="3"><textarea class="form-control" rows="10" style="resize: none" name="appro_context"></textarea></td>
                </tr>
                <tr>
                <td>참고사항</td>
                <td colspan="3">*공가 - 예비군 /민방위의 경우 사후에 참석증을 반드시 제출부탁드립니다.<br>
								*병가 - 연 25회 초과시 무급휴가로 전환 됩니다.<br>
								*경조사 - 사전/사후에 행사일을 증명할 수 있는 서류 제출부탁드립니다.<br>
								*명시된 결재자의 순서에 따라 결재라인이 생성됩니다. (대분류는 협의 > 결재 순)
						</td>
	                </tr>
	          	<tr>
             <td colspan="4">
             <div style="text-align: center;"><h4>상기와 같이 휴가를 신청하오니 검토 후 승인하여 주시기 바랍니다.</h4></div>
             <br><br>
             <h1 style="text-align: center;">물망초등학교</h1>
             
             </td>
           </tr>
                
                
                <tr>
                <td>협의자</td>
                <td colspan="3"><button id="openTreeButton1" class="btn btn-primary" type="button">+</button>
                <input type="text" name="consult" id="selectedNodesTable1" readonly style="border: 0; outline: none; width: calc(100% - 50px);">
                </tr>
                <tr>
                <td>결재자</td>
				    <td colspan="3">
				        <button id="openTreeButton2" class="btn btn-primary" type="button">+</button>
				        <input type="text" name="approval" id="selectedNodesTable2" readonly style="border: 0; outline: none; width: calc(100% - 50px);">
				    </td>
                </tr>
                <tr>
                <td>참조자</td>
                <td colspan="3"><button id="openTreeButton3" class="btn btn-primary" type="button">+</button>
                <input type="text" name="reference" id="selectedNodesTable3" readonly style="border: 0; outline: none; width: calc(100% - 50px);">
                </td>
                </tr>
                <tr>
                <td>첨부파일</td>
                <td colspan="3"><input type="file" name="file_name"></td>
                </tr>
                
            </tbody>
        </table>
        </form>
        <div style= "display: flex; justify-content: space-between; align-items: center;">
        <div class="text-center mt-3">
        	<input type="button" value="목록" class="btn btn-success" th:onclick="|location.href='@{/approve}'|"></button>
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-primary">임시 저장</button>
			<button class="btn btn-success" id="approSubmit">결재 요청</button>
        </div>
        </div>
    </div>
    
    <div class="modal fade" id="treeModal" tabindex="-1" role="dialog" aria-labelledby="treeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="treeModalLabel">Select Nodes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 트리가 렌더링될 영역 -->
                    <div id="jstree_modal"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="confirmSelection">확인</button>
                    <button type="submit" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
            </div>
						</div>
					</div>
				</div>
			</div>
			<!-- ============================================================== -->
			<!-- End PAge Content -->
			<!-- ============================================================== -->
			<!-- ============================================================== -->
			<!-- Right sidebar -->
			<!-- ============================================================== -->
			<!-- .right-sidebar -->
			<!-- ============================================================== -->
			<!-- End Right sidebar -->
			<!-- ============================================================== -->
		</div>
		<!-- ============================================================== -->
		<!-- End Container fluid  -->
		<!-- ============================================================== -->
		<!-- ============================================================== -->
		<!-- footer -->
		<!-- ============================================================== -->
		<footer class="footer text-center text-muted">
			All Rights Reserved by Adminmart. Designed and Developed by <a href="https://wrappixel.com">WrapPixel</a>.
		</footer>
		<!-- ============================================================== -->
		<!-- End footer -->
		<!-- ============================================================== -->
	</div>
	<!-- ============================================================== -->
	<!-- End Page wrapper  -->
	<!-- ============================================================== -->
	</div>
	<!-- ============================================================== -->
	<!-- End Wrapper -->
	<!-- ============================================================== -->
	<!-- End Wrapper -->
	<!-- ============================================================== -->
	<!-- All Jquery -->
	<!-- ============================================================== -->
	<!-- Bootstrap tether Core JavaScript -->
	<script src="assets/libs/popper.js/dist/umd/popper.min.js"></script>
	<script src="assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
	<!-- apps -->
	<!-- apps -->
	<script src="dist/js/app-style-switcher.js"></script>
	<script src="dist/js/feather.min.js"></script>
	<!-- slimscrollbar scrollbar JavaScript -->
	<script src="assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
	<script src="assets/extra-libs/sparkline/sparkline.js"></script>
	<!--Wave Effects -->
	<!-- themejs -->
	<!--Menu sidebar -->
	<script src="dist/js/sidebarmenu.js"></script>
	<!--Custom JavaScript -->
	<script src="dist/js/custom.min.js"></script>
	
	<!-- 반차 선택시 오전/오후 선택기능 활성화 -->
	 <script type="text/javascript">
    function toggleHalfDay(enable) {
        document.getElementById("half_one").disabled = !enable;
        document.getElementById("half_two").disabled = !enable;
    }
    
    </script>
    
    <script>
    document.getElementById("datetime").addEventListener("input", function (e) {
        // 사용자가 입력한 값에서 시간과 분을 가져오기
        let value = e.target.value;
        let date = new Date(value);

        // 분을 00으로 설정
        date.setMinutes(0);

        // 업데이트된 날짜와 시간을 다시 설정 (로컬 시간대 기준)
        let year = date.getFullYear();
        let month = ("0" + (date.getMonth() + 1)).slice(-2); // 월은 0부터 시작하므로 +1 필요
        let day = ("0" + date.getDate()).slice(-2);
        let hours = ("0" + date.getHours()).slice(-2);
        let minutes = "00"; // 항상 00분으로 설정

        let updatedValue = `${year}-${month}-${day}T${hours}:${minutes}`;
        e.target.value = updatedValue;
    });
</script>
    
    <script>
    // 결재 요청 버튼만 유효성 검사를 실행하도록 설정
    const submitApprovalButton = document.getElementById("approSubmit");

    // 결재 요청 버튼 클릭 이벤트 리스너 추가
    submitApprovalButton.addEventListener('click', function(e) {
        e.preventDefault();  // 기본 폼 제출 방지

        // 유효성 검사 로직
        let vali_check = true;

        if (vali_check == false) {
            alert('유효성 검사 중 문제가 발생하였습니다.');
        } else {
            const form = document.getElementById("approCreateFrm");
            const payload = new FormData(form);
            fetch('/approBase', {
                method: 'post',
                body: payload
            })
            .then(response => response.json())
            .then(data => {
                if (data.res_code == '200') {
                    Swal.fire({
                        icon: 'success',
                        title: '성공',
                        text: data.res_msg
                    }).then((result) => {
                        location.href = "/board";
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '실패',
                        text: data.res_msg
                    })
                }
            })
        }
    });
</script>

    
    
	
</th:block>
</html>