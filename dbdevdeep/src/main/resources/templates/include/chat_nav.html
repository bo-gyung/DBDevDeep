<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="chatNavLayout">
	<style>
		/* 화면 크기에 따라 사이드바의 너비 고정 */
        @media (max-width: 1200px) {
            .sidebar_container {
                overflow-x: hidden; /* 가로 스크롤을 숨기기 */
            }
        }
        /* 사이드바 컨테이너 스타일링 */
        .sidebar_container {
            display: flex;
            flex-direction: column;
            gap: 20px; /* sidebar_div 사이의 간격 */
            padding: 20px; /* sidebar_container와 사이드바의 간격 */
            height: calc(100vh - 100px); /* 컨테이너의 높이를 뷰포트의 높이에서 패딩을 뺀 값으로 설정 */
            max-width: 300px; /* 사이드바의 최대 너비 설정 */
        }

        /* 사이드바 내 div 스타일링 */
        .sidebar_div {
            border: 3px solid rgb(219, 219, 219); /* 테두리 색상 및 두께 */
            width: 100%; /* 너비를 컨테이너에 맞추기 */
            height: calc((100% - 20px) / 2); /* 높이를 컨테이너의 반절로 설정 (간격을 고려) */
            border-radius: 10px;
        }

        /* 프로필 섹션 스타일링 */
        .profile_section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding : 20px; /* 패딩 추가 */
        }

        /* 프로필 이미지 스타일링 */
        .profile_image {
            width: 120px; /* 프로필 이미지의 너비 */
            height: 120px; /* 프로필 이미지의 높이 */
            border-radius: 50%; /* 원형으로 만들기 */
            overflow: hidden; /* 원형 테두리 안에서 이미지가 잘리도록 설정 */
            margin: 20px; /* 이미지 간격 */
        }

        .profile_image img {
            width: 100%; /* 이미지의 너비를 컨테이너에 맞추기 */
            height: 100%; /* 이미지의 높이를 컨테이너에 맞추기 */
            object-fit: cover; /* 이미지 비율 유지하며 자르기 */
         }

         /* 이름 스타일링 */
         .profile_name div {
            margin: 5px; /* 기본 여백 제거 */
            font-size: 18px; /* 이름의 글자 크기 */
            font-weight:bolder; /* 이름을 굵게 표시 */
            color: black;
         }

         .point_label {
            font-weight: bolder; /* 라벨을 굵게 표시 */
            color: black;
         }

         /* 상태메세지 div 스타일링 */
		.profile_status {
			display: flex;
		    flex-direction: column; /* test와 버튼을 위아래로 배치 */
		    align-items: center;    /* 중앙 정렬 */
		    width: 100%;            /* 부모 요소의 너비에 맞춤 */
		    gap: 10px;     
		}

		.status_btn {
			font-size: 16px; 		/* 버튼 글자 크기 */
			width: 100%;            /* 버튼을 부모 요소 너비에 맞춤 */
		    background-color: #0031AE; /* 버튼 배경색 (원하는 색으로 변경 가능) */
		    color: white;           /* 버튼 텍스트 색상 */
		    padding: 10px;          /* 버튼 안쪽 여백 */
		    border: none;           /* 버튼 테두리 제거 */
		    border-radius: 5px;     /* 버튼 모서리를 둥글게 */
		    cursor: pointer;        /* 커서가 손가락 모양으로 변하도록 설정 */
		}

        .status_btn:hover{
            background-color: #00278a; /* 버튼 색상 */
            color: white;
        }

		
		/* 대화상대 목록 섹션 스타일링 */
		.emplist_section{
			display: flex;
		    flex-direction: column;
		    align-items: flex-start; /* 수평으로 왼쪽 정렬 */
		    justify-content: flex-start; /* 수직으로 위쪽 정렬 */
		}
		#sidejstree.jstree {
		    margin: 0;  /* 요소의 바깥 여백 제거 */
		    padding: 0; /* 요소의 안쪽 여백 제거 */
		}
		
		#jstree_demo_div {
			max-height: 300px; /* 원하는 최대 높이를 설정 */
		    width: 100%; /* 너비를 부모 요소에 맞추기 */
		}
        
        </style>
        <!-- 내 프로필 변경 모달창 시작 -->
        <div class="modal fade" id="edit_status_modal" tabindex="-1" role="dialog"
	        aria-labelledby="mySmallModalLabel" aria-hidden="true">
	        <div class="modal-dialog modal-sm">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <h4 class="modal-title" id="mySmallModalLabel">프로필 변경</h4>
	                    <button type="button" class="close" data-dismiss="modal"
	                        aria-hidden="true">×</button>
	                </div>
	                <div class="modal-body">
	                    <div class="sidebar_div profile_section">
	                        <div class="profile_image">
	                            <img th:src="@{'/UploadImg/employee/' + ${loginEmp.new_pic_name}}" alt="Profile Picture">
	                        </div>
	                        <!-- 이름 -->
	                        <div class="profile_name">
	                            <div><span class="text-dark" th:text="${loginEmp.emp_name}"></span></div>
	                        </div>
	                        <!-- 상태메세지 -->
	                        <div class="profile_status">
	                        	<form id="editStatusForm">
		                        	<textarea th:text="${loginEmp.chat_status_msg}" 
		                        	rows="3" cols="24" style="resize: none;" id="chat_status_msg" name="chat_status_msg"></textarea>
		                            <!-- CSRF정보를 담은 히든 인풋 -->
									<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
		                            <input type="hidden" th:value="${loginEmp.emp_id}" id="emp_id" name="emp_id">
		                            <button type="submit" class="status_btn">변경하기</button>
	                        	</form>
	                        </div>
                        </div>
	                </div>
	            </div><!-- /.modal-content -->
	        </div><!-- /.modal-dialog -->
	    </div><!-- /.modal -->
	    <!-- 내 프로필 변경 모달창 끝 -->
	    <!-- 상대방 프로필 모달창 시작 -->
        <div class="modal fade" id="profile_modal" tabindex="-1" role="dialog"
	        aria-labelledby="mySmallModalLabel" aria-hidden="true">
	        <div class="modal-dialog modal-sm">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <h4 class="modal-title" id="mySmallModalLabel">프로필 보기</h4>
	                    <button type="button" class="close" data-dismiss="modal"
	                        aria-hidden="true">×</button>
	                </div>
	                <div class="modal-body">
	                    <div class="sidebar_div profile_section">
	                        <div class="profile_image">
	                        	<!-- 사진 -->
	                            <img src="" id="profile_pic_modal" alt="Profile Picture">
	                        </div>
	                        <!-- 이름 -->
	                        <div class="profile_name">
	                            <div><span class="text-dark" id="profile_name_modal"></span></div>
	                        </div>
	                        <!-- 상태메세지 -->
	                        <div class="profile_status">
	                        	<div class="text-center"><span class="text-dark" id="profile_status_modal"></span></div>
	                        	<form id="profileChatForm">
		                            <!-- CSRF정보를 담은 히든 인풋 -->
									<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
		                            <input type="hidden" id="emp_id_modal">
		                            <button type="submit" class="status_btn">채팅하기</button>
	                        	</form>
	                        </div>
                        </div>
	                </div>
	            </div><!-- /.modal-content -->
	        </div><!-- /.modal-dialog -->
	    </div><!-- /.modal -->
	    <!-- 상대방 프로필 모달창 끝 -->
	    <!-- 사이드바 시작 -->
        <aside class="left-sidebar" data-sidebarbg="skin6">
            <!-- Sidebar scroll-->
            <div class="" data-sidebarbg="skin6">
                <!-- Sidebar navigation-->
                <div class="sidebar_container">
                    <div class="sidebar_div profile_section">
                        <div class="profile_image">
                            <img th:src="@{'/UploadImg/employee/' + ${loginEmp.new_pic_name}}" alt="Profile Picture">
                        </div>
                        <!-- 이름 -->
                        <div class="profile_name">
                            <div><span class="text-dark" th:text="${loginEmp.emp_name}"></span></div>
                        </div>
                        <!-- 상태메세지 -->
                        <div class="profile_status">
                            <div class="text-center"><span class="text-dark" th:text="${loginEmp.chat_status_msg}" id="statusMsg"></span></div>
                        	<button type="button" class="status_btn" data-toggle="modal" 
                        	data-target="#edit_status_modal">변경하기</button>
                        </div>
					</div>
                    <div class="sidebar_div emplist_section">
	                    <form class="p-2">
	                        <input class="form-control" type="text" placeholder="Search Contact">
	                    </form>
                        <div class="point_label px-2">대화상대 목록</div>
                        <div id="jstree_demo_div" class="scroll-sidebar">
                        	<ul id="sidejstree"></ul>
                        </div>
                        <div class="profile_status"style="padding : 20px;">
                        	<button class="status_btn" id="checkInBtn">채팅하기</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <!-- 사이드바 끝 -->
    <!-- 대화상대 목록 jstree 출력 -->
    <script>
        $(document).ready(function() {
            fetch('/api/emp-tree')
                .then(response => response.json())
                .then(data => {
                	// 받아온 데이터로 트리구조 만들기
                    const D1Data = D1(data.employees, data.teacherHistory);
                    const D2Data = D2(data.employees, data.teacherHistory);
                    const D3Data = D3(data.employees);
                    const D3J4Data = D3J4(data.employees);
                    const D4Data = D4(data.employees, data.teacherHistory);
                    const D4J4Data = D4J4(data.employees, data.teacherHistory)
                    
                    
                    $('#sidejstree').jstree({
                    	'core': {
		        					'data': Object.keys(D1Data).length !== 0 
		        						? D1Data : Object.keys(D2Data).length !== 0
		        								 ? D2Data : Object.keys(D3Data).length !== 0 
		        										? [...D3Data, ...D4Data] : Object.keys(D3Data).length !== 0
		        												? [...D3J4Data, ...D4Data] : Object.keys(D4Data).length !== 0
		        														? [...D3Data, ...D4J4Data] : Object.keys(D3Data).length !== 0 && Object.keys(D4Data).length !== 0
		        																? [...D3J4Data, ...D4J4Data] : [],
									"themes" : {
							            "responsive": false
							        }	
		        				},
		        		
		        				"types" : {
		        			        "default" : {
		        			            "icon" : "fas fa-user" // 아이콘 변경
		        			        }
		        			    },
		        			    "plugins": ["types"]
                    
                    });
                    
                    
                });
            
            function getTeacherHistory(empId, teacherHistory) {
                const history = teacherHistory.find(t => t.teach_emp_id === empId);
                return history ? { grade: history.grade, grade_class: history.grade_class } : { grade: null, grade_class: null };
            }
            
            // 교장
            function D1(items, historys) {
            	return items
            		.filter(item => item.dept_code == 'D1')
            		.map(item => {
            			return {
            				"text": item.dept_name + " " + item.emp_name,
            				"state" : { "opened" : true },
            				"children" : D2(items, historys)
            			};
            		});
            }
            
            // 교감
            function D2(items, historys) {
            	return items
            		.filter(item => item.dept_code == 'D2')
            		.map(item => {
            			return {
            				"text": item.dept_name + " " + item.emp_name,
            				"state" : { "opened" : true },
            				"children" : [...D3(items), ...D4(items, historys)]
            				
            			}
            		})
            }
            
            // 행정부장
            function D3(items) {
            	return items
            		.filter(item => item.dept_code == 'D3' && item.job_code == 'J3')
            		.map(item => {
            			return {
            				"text": item.dept_name + "장 " + item.emp_name,
            				"state" : { "opened" : true },
            				"children" : D3J4(items)
            			}
            		})
            }
            
            // 행정직원
            function D3J4(items) {
            	return items
            		.filter(item => item.dept_code == 'D3' && item.job_code == 'J4')
            		.map(item => {
            			return {
            				"text": item.emp_name,
            				"state" : { "opened" : false }
            			}
            		})
            		.sort((a, b) => {
            			return a.text.localeCompare(b.text); // 이름 순으로 정렬
            		});
            }
            
            // 교무부장
            function D4(items, historys) {
            	return items
            		.filter(item => item.dept_code == 'D4' && item.job_code == 'J3')
            		.map(item => {
            			const history = getTeacherHistory(item.emp_id, historys);
            			return {
            				"text": item.dept_name + "장 " + item.emp_name,
            				"state" : { "opened" : true },
            				"children" : D4J4(items, historys)
            			}
            		})
            }
            
            // 교무직원
            function D4J4(items, historys) {
            	return items
            		.filter(item => item.dept_code == 'D4' && item.job_code == 'J4')
            		.map(item => {
            			return {
            				"text": item.emp_name,
            				"state" : { "opened" : false }
            			}
            		})
            		.sort((a, b) => {
                        const matchA = a.text.match(/\((\d+)-(\d+)\)/);
                        const matchB = b.text.match(/\((\d+)-(\d+)\)/);

                        const gradeA = matchA ? parseInt(matchA[1], 10) : null;
                        const gradeB = matchB ? parseInt(matchB[1], 10) : null;
                        const classA = matchA ? parseInt(matchA[2], 10) : null;
                        const classB = matchB ? parseInt(matchB[2], 10) : null;

                        if (gradeA !== null && gradeB !== null) {
                            if (gradeA === gradeB) {
                                return (classA !== null ? classA : 0) - (classB !== null ? classB : 0); // 학년이 같은 경우 반 순으로 정렬
                            } else {
                                return gradeA - gradeB; // 학년이 다른 경우 학년 순으로 정렬
                            }
                        } else if (gradeA !== null) {
                            return -1; // 두 값 중 하나가 null인 경우 학년이 있는 값 순으로 정렬
                        } else if (gradeB !== null) {
                            return 1; // 두 값 중 하나가 null인 경우 학년이 있는 값 순으로 정렬
                        } else {
                            return a.text.localeCompare(b.text); // 두 값이 null이면 이름 순으로 정렬
                        }
                    });
            }
            		
        });   	
	</script>
	<!-- 대화상대 프로필 출력 -->
	<script>
		$('#sidejstree').on("select_node.jstree", function (e, data) {
			// 클릭된 노드의 정보
			const selectedNode = data.node;
			// 노드의 아이디값
			const empId = selectedNode.emp_id;
		    
		    // fetch로 empId의 회원정보 가져오기
		    fetch('/profile/${empId}',{
		    	method:'GET',
		    	headers:{
		    		// 서버에 JSON 형식으로 응답을 요청
		    		'Accept': 'application/json'
		    	}
		    })
		    .then(response=>response.json())
			.then(data=>{
				if(data!=null){
			    	// 성공 시 모달창에 회원정보 넣기
			    	document.getElementById('rofile_pic_modal').src = `/UploadImg/employee/${data.new_pic_name}`; 
			    	document.getElementById('profile_name_modal').innerText = data.emp_name;
			    	document.getElementById('profile_status_modal').innerText = 
			    	document.getElementById('emp_id_modal').value = 
			    	// 모달 열기
					$('#profile_modal').modal('show');
				} else{
					// 실패 시
				}
			})
		    
		});
	</script>
	<!-- 프로필 채팅방 생성 (일대일) -->
	<script>
	</script>
	<!-- 내 상태 메세지 수정 -->
	<script>
	// 상태메세지 수정하기
	const form = document.getElementById("editStatusForm");
		form.addEventListener('submit',(e)=>{
  	 		e.preventDefault();
  	 		
			const empId = document.getElementById('emp_id').value;
			const csrfToken = document.getElementById("csrf_token").value;
			
			const payload = new FormData(form);
			let obj = {};
  			payload.forEach(function(value,key){
  				obj[key]=value;
  			})
			const jsonData = JSON.stringify(obj);
  			
  			fetch('status/${empId}',{
  				method:'POST',
  				headers:{
  					"Content-Type": "application/json;charset=utf-8",
  					"Accept": "application/json",
  					"X-CSRF-TOKEN": csrfToken
  				},
  				body: jsonData
  				})
  				.then(response=>response.json())
  				.then(data=>{
  					if(data.res_code == '200'){
  						Swal.fire({
  							icon :'success',
  							title:'성공',
  							text : data.res_msg
  						}).then((result)=>{
  							// 상태 메시지 갱신	
  							document.getElementById('statusMsg').innerText = document.getElementById('chat_status_msg').value;
  							// 모달 닫기
  							$('#edit_status_modal').modal('hide');
  							
  						});
  					} else{
  						Swal.fire({
  							icon:'error',
  							title:'실패',
  							text: data.res_msg
  						});
  					}
  				})
  			});
  				
	</script>

</th:block>
</html>