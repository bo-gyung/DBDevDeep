<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{include/attendance_layout}">
     
     <head>
    <!-- This page plugin CSS -->
    <link href="/assets/extra-libs/datatables.net-bs4/css/dataTables.bootstrap4.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/dist/css/style.min.css" rel="stylesheet">
<style>
		div.dataTables_wrapper div.dataTables_paginate ul.pagination {
		  margin: 2px 0;
		  white-space: nowrap;
		  justify-content: center;
		}	
		
		h6 {
    margin-left: 50px; /* 문자와 숫자 간의 간격을 줄이기 위해 오른쪽 마진 조정 */
		}

		h2 {
    margin-right: 50px; /* 문자와 숫자 간의 간격을 줄이기 위해 왼쪽 마진 조정 */
		}
		
	</style>

</head>


<th:block layout:fragment="content">

		<!-- ============================================================== -->
		<!-- End Left Sidebar - style you can find in sidebar.scss  -->
		<!-- ============================================================== -->
		<!-- ============================================================== -->
		<!-- Page wrapper  -->
		<!-- ============================================================== -->
		<div class="page-wrapper">
			<!-- ============================================================== -->
			<!-- Container fluid  -->
			<!-- ============================================================== -->
			<div class="container-fluid">
				<!-- ============================================================== -->
				<!-- Start Page Content -->
				<!-- ============================================================== -->
				<div class="col-sm-12 col-md-12">
					<div class="card">
						<div class="card-body">
							<h3 class="card-title" th:text="${#authentication.principal.dto.emp_name}+' 님의 근태관리'"></h3>
							<input type="hidden" id="enterUser" name="enterUser" th:value="${#authentication.principal.dto.emp_id}"> 
							<hr>
							
							
							<div class="container-fluid">
				<!-- ============================================================== -->
				<!-- Start Page Content -->
				<!-- ============================================================== -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
		                        <div class="row mb-2">
	                            </div>
                                <div class="table-responsive">
                                    <table id="attendance_config" class="table table-hover table-bordered no-wrap" style="width:100%">
                                        <thead>
                                        <div><span th:text="${result.vacation_hour}"></span></div>
                                        
										    <div class="col-md-4">
										        <input type="month" id="searchYandM" name="searchYandM" class="form-control" value="">
										    </div>
										    <br>
										    <div class="card-group">
											    <div class="card border-right">
											        <div class="card-body">
											            <div class="d-flex d-lg-flex d-md-block align-items-center">
											                <div style="display: flex; justify-content: space-evenly; align-items: center; width: 100%;">
											                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">출근</h6>
											                    <h2 id="attendanceCount" class="text-dark mb-1 font-weight-medium"></h2>
											                </div>
											            </div>
											        </div>
											    </div>
											    <div class="card border-right">
											        <div class="card-body">
											            <div class="d-flex d-lg-flex d-md-block align-items-center">
											                <div style="display: flex; justify-content: space-evenly; align-items: center; width: 100%;">
											                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">결근</h6>
											                    <h2 id="absenceCount" class="text-dark mb-1 font-weight-medium"></h2>
											                </div>
											            </div>
											        </div>
											    </div>
											    <div class="card border-right">
											        <div class="card-body">
											            <div class="d-flex d-lg-flex d-md-block align-items-center">
											                <div style="display: flex; justify-content: space-evenly; align-items: center; width: 100%;">
											                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">지각</h6>
											                    <h2 id="lateCount" class="text-dark mb-1 font-weight-medium"></h2>
											                </div>
											            </div>
											        </div>
											    </div>
											    <div class="card">
											        <div class="card-body">
											            <div class="d-flex d-lg-flex d-md-block align-items-center">
											                <div style="display: flex; justify-content: space-evenly; align-items: center; width: 100%;">
											                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">초과근무</h6>
											                    <h2 class="text-dark mb-1 font-weight-medium"></h2>
											                </div>
											            </div>
											        </div>
											    </div>
											</div>

                                            <tr>
                                                <th>일</th>
                                                <th>출근시간</th>
                                                <th>퇴근시간</th>
                                                <th>상태</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceData">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- End PAge Content -->
                <!-- ============================================================== -->
                <!-- ============================================================== -->
                <!-- Right sidebar -->
                <!-- ============================================================== -->
                <!-- .right-sidebar -->
                <!-- ============================================================== -->
                <!-- End Right sidebar -->
                <!-- ============================================================== -->
				            </div>
						</div>
					</div>
				</div>
			</div>
			<!-- ============================================================== -->
			<!-- End PAge Content -->
			<!-- ============================================================== -->
			<!-- ============================================================== -->
			<!-- Right sidebar -->
			<!-- ============================================================== -->
			<!-- .right-sidebar -->
			<!-- ============================================================== -->
			<!-- End Right sidebar -->
			<!-- ============================================================== -->
		</div>
		<!-- ============================================================== -->
		<!-- End Container fluid  -->
		<!-- ============================================================== -->
		<!-- ============================================================== -->
		<!-- footer -->
		<!-- ============================================================== -->
		<footer class="footer text-center text-muted">
			All Rights Reserved by Adminmart. Designed and Developed by <a href="https://wrappixel.com">WrapPixel</a>.
		</footer>
		<!-- ============================================================== -->
		<!-- End footer -->
		<!-- ============================================================== -->
	</div>
	<!-- ============================================================== -->
	<!-- End Page wrapper  -->
	<!-- ============================================================== -->
	</div>
	<!-- ============================================================== -->
	<!-- End Wrapper -->
	<!-- ============================================================== -->
	<!-- End Wrapper -->
	<!-- ============================================================== -->
	<!-- All Jquery -->
	<!-- ============================================================== -->
	
	
	<script src="assets/libs/jquery/dist/jquery.min.js"></script>
	<!-- Bootstrap tether Core JavaScript -->
	<script src="assets/libs/popper.js/dist/umd/popper.min.js"></script>
	<script src="assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
	<!-- apps -->
	<!-- apps -->
	<script src="dist/js/app-style-switcher.js"></script>
	<script src="dist/js/feather.min.js"></script>
	<!-- slimscrollbar scrollbar JavaScript -->
	<script src="assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
	<script src="assets/extra-libs/sparkline/sparkline.js"></script>
	<!--Wave Effects -->
	<!-- themejs -->
	<!--Menu sidebar -->
	<script src="dist/js/sidebarmenu.js"></script>
	<!--Custom JavaScript -->
	<script src="dist/js/custom.min.js"></script>
	<script src="/assets/extra-libs/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/dist/js/pages/datatable/datatable-basic.init.js"></script>
    
    <script>
		const empId = document.getElementById("enterUser").value;
		$(document).ready(function(){
			let today = new Date();
			let year = today.getFullYear();
			let month = ('0' + (today.getMonth()+1)).slice(-2);
			$('#searchYandM').val(`${year}-${month}`);
			
			loadAttendanceData(year, month);
			
			$('#searchYandM').on('change', function(){
				let changeDate = $(this).val();
				let changeYear = changeDate.split('-')[0];
				let changeMonth = changeDate.split('-')[1];
				
				loadAttendanceData(changeYear , changeMonth);
			});
		});
		
		function loadAttendanceData(year, month){
			$('#attendanceCount').text(0);
		    $('#absenceCount').text(0);
		    $('#lateCount').text(0);
			
			$.ajax({
				url: '/changeAttendance',
				method: 'GET',
				data: {empId: empId, year: year, month: month},
				success: function(response){
					let attendanceData = $('#attendanceData');
					attendanceData.empty();
					
					let attendanceCount = 0;
					let absenceCount = 0; 
					let lateCount = 0;
					
					if (response.length === 0) {
						attendanceData.append('<tr><td colspan="4">출퇴근 기록 정보가 없습니다.</td></tr>');
		            } else {
		                $.each(response, function(index, item) {
		                	attendanceData.append(`
		                        <tr>
		                            <td>${item.attend_date}</td>
		                            <td>${item.check_in_time}</td>
		                            <td>${item.check_out_time}</td>
		                            <td>${item.work_status}</td>
		                        </tr>
		                    `);
		                	if(item.work_status === 1 || item.work_status === 2){
		                		attendanceCount++;
		                	}
		                	if(item.work_status === 3){
		                		absenceCount++;
		                	}
		                	if (item.late_status == "Y") {
		                        lateCount++;
		                    }
		                });

		                $('#attendanceCount').text(attendanceCount);
		                $('#absenceCount').text(absenceCount);
		                $('#lateCount').text(lateCount);
		            }
		        },
		        error: function() {
		            alert('데이터를 불러오는 중 오류가 발생했습니다.');
		        }
		    });
		}
	</script>
    	
</th:block>
</html>